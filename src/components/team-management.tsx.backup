'use client'

import { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '@/components/ui/alert-dialog'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import { useToast } from '@/hooks/use-toast'
import { Users, Plus, Edit, Trash2, Settings, UserPlus, Phone, DollarSign } from 'lucide-react'
import { api } from '@/lib/api'

interface Member {
  id: string
  name: string
  phone: string
  bankName?: string
  bankAccount?: string
  bankBranch?: string
  salary: number
  teamId: string
  team?: {
    id: string
    name: string
  }
  createdAt: string
}

export function TeamManagement() {
  const { toast } = useToast()
  
  const [teams, setTeams] = useState<any[]>([])
  const [members, setMembers] = useState<Member[]>([])
  const [loading, setLoading] = useState(true)
  const [newTeam, setNewTeam] = useState({
    name: '',
    description: '',
    leader: '',
    budget: ''
  })
  const [newMember, setNewMember] = useState({
    name: '',
    phone: '',
    bankName: '',
    bankAccount: '',
    bankBranch: '',
    salary: '',
    teamId: ''
  })
  const [editingMember, setEditingMember] = useState<Member | null>(null)
  const [editingTeam, setEditingTeam] = useState<any>(null)
  const [isTeamDialogOpen, setIsTeamDialogOpen] = useState(false)
  const [isMemberDialogOpen, setIsMemberDialogOpen] = useState(false)

  useEffect(() => {
    fetchData()
  }, [])

  const fetchData = async () => {
    try {
      const [teamsData, membersData] = await Promise.all([
        api.teams.getAll(),
        api.members.getAll()
      ])
      setTeams(teamsData)
      setMembers(membersData)
    } catch (error) {
      console.error('Error fetching data:', error)
      // Fallback to mock data if API fails
      setTeams([
        {
          id: 1,
          name: '‡∏ó‡∏µ‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î',
          description: '‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤',
          leader: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
          budget: 50000,
          color: 'blue'
        },
        {
          id: 2,
          name: '‡∏ó‡∏µ‡∏°‡∏Ç‡∏≤‡∏¢',
          description: '‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
          leader: '‡∏™‡∏°‡∏®‡∏£‡∏µ ‡∏£‡∏±‡∏Å‡∏î‡∏µ',
          budget: 75000,
          color: 'green'
        },
        {
          id: 3,
          name: '‡∏ó‡∏µ‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
          description: '‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
          leader: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô',
          budget: 30000,
          color: 'purple'
        }
      ])
      setMembers([])
    } finally {
      setLoading(false)
    }
  }

  const handleAddTeam = () => {
    if (newTeam.name && newTeam.description) {
      if (editingTeam) {
        // Update existing team
        setTeams(teams.map(team => 
          team.id === editingTeam.id 
            ? { ...team, ...newTeam, budget: parseInt(newTeam.budget) || 0 }
            : team
        ))
        setEditingTeam(null)
        setIsTeamDialogOpen(false)
      } else {
        // Add new team
        const team = {
          id: teams.length + 1,
          ...newTeam,
          budget: parseInt(newTeam.budget) || 0,
          color: ['blue', 'green', 'purple', 'orange', 'red'][teams.length % 5]
        }
        setTeams([...teams, team])
      }
      setNewTeam({ name: '', description: '', leader: '', budget: '' })
    }
  }

  const handleAddMember = async () => {
    if (newMember.name && newMember.phone && newMember.salary && newMember.teamId) {
      try {
        const memberData = {
          ...newMember,
          salary: parseInt(newMember.salary) || 0
        }
        
        if (editingMember) {
          // Update existing member
          await api.members.update(editingMember.id, memberData)
          toast({
            title: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            description: `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å "${newMember.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          })
        } else {
          // Add new member
          await api.members.create(memberData)
          toast({
            title: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            description: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å "${newMember.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          })
        }
        
        await fetchData()
        setIsMemberDialogOpen(false)
        resetMemberForm()
      } catch (error) {
        console.error('Error saving member:', error)
        // Fallback to local state if API fails
        const selectedTeam = teams.find(t => t.id.toString() === newMember.teamId)
        const member = {
          id: editingMember?.id || Date.now().toString(),
          ...newMember,
          salary: parseInt(newMember.salary) || 0,
          createdAt: editingMember?.createdAt || new Date().toISOString(),
          team: selectedTeam ? {
            id: selectedTeam.id.toString(),
            name: selectedTeam.name
          } : null
        }
        
        if (editingMember) {
          // Update existing member in local state
          setMembers(members.map(m => m.id === editingMember.id ? member : m))
          toast({
            title: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            description: `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å "${newMember.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          })
        } else {
          // Add new member to local state
          setMembers([...members, member])
          toast({
            title: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
            description: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å "${newMember.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          })
        }
        
        setIsMemberDialogOpen(false)
        resetMemberForm()
      }
    }
  }

  const handleEditMember = (member: Member) => {
    setEditingMember(member)
    setNewMember({
      name: member.name,
      phone: member.phone,
      bankName: member.bankName || '',
      bankAccount: member.bankAccount || '',
      bankBranch: member.bankBranch || '',
      salary: member.salary.toString(),
      teamId: member.teamId
    })
    setIsMemberDialogOpen(true)
  }

  const handleEditTeam = (team: any) => {
    setEditingTeam(team)
    setNewTeam({
      name: team.name,
      description: team.description,
      leader: team.leader,
      budget: team.budget.toString()
    })
    setIsTeamDialogOpen(true)
  }

  const handleDeleteTeam = (id: number) => {
    setTeams(teams.filter(team => team.id !== id))
    // Also remove members from this team
    setMembers(members.filter(member => member.teamId !== id.toString()))
  }

  const handleDeleteMember = async (id: string) => {
    try {
      if (api.members.delete) {
        await api.members.delete(id)
      }
      await fetchData()
      toast({
        title: "‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        description: "‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
      })
    } catch (error) {
      console.error('Error deleting member:', error)
      // Fallback to local state
      const member = members.find(m => m.id === id)
      setMembers(members.filter(member => member.id !== id))
      toast({
        title: "‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        description: `‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å "${member?.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
      })
    }
  }

  const resetMemberForm = () => {
    setNewMember({
      name: '',
      phone: '',
      bankName: '',
      bankAccount: '',
      bankBranch: '',
      salary: '',
      teamId: ''
    })
    setEditingMember(null)
  }

  const getTeamColor = (color: string) => {
    const colors: { [key: string]: string } = {
      blue: 'bg-blue-100 text-blue-800',
      green: 'bg-green-100 text-green-800',
      purple: 'bg-purple-100 text-purple-800',
      orange: 'bg-orange-100 text-orange-800',
      red: 'bg-red-100 text-red-800'
    }
    return colors[color] || 'bg-gray-100 text-gray-800'
  }

  const getMembersByTeam = (teamId: string | number) => {
    return members.filter(member => {
      if (typeof teamId === 'string') {
        return member.teamId === teamId
      } else {
        return member.teamId === teamId.toString()
      }
    })
  }

  if (loading) {
    return <div className="flex items-center justify-center h-64">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold text-gray-900">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</h1>
        <p className="text-gray-600 mt-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
      </div>

      {/* Statistics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{teams.length}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{members.length}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">‡∏ø{teams.reduce((sum, team) => sum + (team.budget || 0), 0).toLocaleString()}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏° (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{teams.length > 0 ? (members.length / teams.length).toFixed(1) : 0}</div>
          </CardContent>
        </Card>
      </div>

      {/* Action Buttons */}
      <div className="flex gap-4">
        <Dialog open={isTeamDialogOpen} onOpenChange={setIsTeamDialogOpen}>
          <DialogTrigger asChild>
            <Button onClick={() => { setEditingTeam(null); setNewTeam({ name: '', description: '', leader: '', budget: '' }); }}>
              <Plus className="h-4 w-4 mr-2" />
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°
            </Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>{editingTeam ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏°' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà'}</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="team-name">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</Label>
                <Input
                  id="team-name"
                  value={newTeam.name}
                  onChange={(e) => setNewTeam({ ...newTeam, name: e.target.value })}
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="team-description">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</Label>
                <Textarea
                  id="team-description"
                  value={newTeam.description}
                  onChange={(e) => setNewTeam({ ...newTeam, description: e.target.value })}
                  placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°..."
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="team-leader">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°</Label>
                <Input
                  id="team-leader"
                  value={newTeam.leader}
                  onChange={(e) => setNewTeam({ ...newTeam, leader: e.target.value })}
                  placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="team-budget">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</Label>
                <Input
                  id="team-budget"
                  type="number"
                  value={newTeam.budget}
                  onChange={(e) => setNewTeam({ ...newTeam, budget: e.target.value })}
                  placeholder="0"
                />
              </div>
              <Button onClick={handleAddTeam} className="w-full">
                {editingTeam ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°'}
              </Button>
            </div>
          </DialogContent>
        </Dialog>

        <Dialog open={isMemberDialogOpen} onOpenChange={setIsMemberDialogOpen}>
          <DialogTrigger asChild>
            <Button variant="outline" onClick={() => { resetMemberForm(); }}>
              <UserPlus className="h-4 w-4 mr-2" />
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
            </Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>{editingMember ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà'}</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="member-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</Label>
                <Input
                  id="member-name"
                  value={newMember.name}
                  onChange={(e) => setNewMember({ ...newMember, name: e.target.value })}
                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="member-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</Label>
                <Input
                  id="member-phone"
                  value={newMember.phone}
                  onChange={(e) => setNewMember({ ...newMember, phone: e.target.value })}
                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="member-bank-name">‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</Label>
                <Input
                  id="member-bank-name"
                  value={newMember.bankName}
                  onChange={(e) => setNewMember({ ...newMember, bankName: e.target.value })}
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="member-bank-account">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</Label>
                <Input
                  id="member-bank-account"
                  value={newMember.bankAccount}
                  onChange={(e) => setNewMember({ ...newMember, bankAccount: e.target.value })}
                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="member-bank-branch">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</Label>
                <Input
                  id="member-bank-branch"
                  value={newMember.bankBranch}
                  onChange={(e) => setNewMember({ ...newMember, bankBranch: e.target.value })}
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏¢‡∏≤‡∏°"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="member-salary">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</Label>
                <Input
                  id="member-salary"
                  type="number"
                  value={newMember.salary}
                  onChange={(e) => setNewMember({ ...newMember, salary: e.target.value })}
                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="member-team">‡∏ó‡∏µ‡∏°</Label>
                <Select value={newMember.teamId} onValueChange={(value) => setNewMember({ ...newMember, teamId: value })}>
                  <SelectTrigger>
                    <SelectValue placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°" />
                  </SelectTrigger>
                  <SelectContent>
                    {teams.map((team) => (
                      <SelectItem key={team.id} value={team.id.toString()}>
                        {team.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <Button onClick={handleAddMember} className="w-full">
                {editingMember ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {/* Teams Section */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Users className="h-5 w-5" />
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {teams.map((team) => {
              const teamMembers = getMembersByTeam(team.id)
              return (
                <div key={team.id} className="border rounded-lg">
                  <div className="flex items-center justify-between p-4">
                    <div className="flex items-center gap-4">
                      <div className={`p-2 rounded-lg ${getTeamColor(team.color)}`}>
                        <Users className="h-5 w-5" />
                      </div>
                      <div>
                        <h3 className="font-semibold">{team.name}</h3>
                        <p className="text-sm text-gray-500">{team.description}</p>
                        <div className="flex items-center gap-4 mt-1">
                          <span className="text-sm text-gray-500">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤: {team.leader}</span>
                          <span className="text-sm text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: {teamMembers.length} ‡∏Ñ‡∏ô</span>
                          <span className="text-sm text-gray-500">‡∏á‡∏ö: ‡∏ø{(team.budget || 0).toLocaleString()}</span>
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <Button 
                        variant="ghost" 
                        size="sm"
                        onClick={() => handleEditTeam(team)}
                      >
                        <Edit className="h-4 w-4" />
                      </Button>
                      <AlertDialog>
                        <AlertDialogTrigger asChild>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            className="text-red-600 hover:text-red-700"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </AlertDialogTrigger>
                        <AlertDialogContent>
                          <AlertDialogHeader>
                            <AlertDialogTitle>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏µ‡∏°</AlertDialogTitle>
                            <AlertDialogDescription>
                              ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏µ‡∏° "{team.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                              ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
                              ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
                            </AlertDialogDescription>
                          </AlertDialogHeader>
                          <AlertDialogFooter>
                            <AlertDialogCancel>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</AlertDialogCancel>
                            <AlertDialogAction 
                              onClick={() => handleDeleteTeam(team.id)}
                              className="bg-red-600 hover:bg-red-700"
                            >
                              ‡∏•‡∏ö‡∏ó‡∏µ‡∏°
                            </AlertDialogAction>
                          </AlertDialogFooter>
                        </AlertDialogContent>
                      </AlertDialog>
                    </div>
                  </div>
                  
                  {/* Team Members */}
                  <div className="border-t bg-gray-50 px-4 py-3">
                    <div className="flex items-center gap-2 mb-2">
                      <Users className="h-4 w-4 text-gray-600" />
                      <span className="text-sm font-medium text-gray-700">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏° ({teamMembers.length} ‡∏Ñ‡∏ô)</span>
                    </div>
                    {teamMembers.length > 0 ? (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                        {teamMembers.map((member) => (
                          <div key={member.id} className="flex items-center justify-between bg-white p-3 rounded border">
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                                <span className="text-xs font-medium">
                                  {member.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                </span>
                              </div>
                              <div>
                                <p className="text-sm font-medium">{member.name}</p>
                                <div className="flex items-center gap-2 text-xs text-gray-500">
                                  <Phone className="h-3 w-3" />
                                  {member.phone}
                                </div>
                                {member.bankName && (
                                  <div className="text-xs text-gray-500">
                                    üè¶ {member.bankName} {member.bankAccount && `(${member.bankAccount})`}
                                  </div>
                                )}
                              </div>
                            </div>
                            <div className="flex flex-col items-end gap-1">
                              <div className="flex items-center gap-1 text-xs text-gray-600">
                                <DollarSign className="h-3 w-3" />
                                {member.salary.toLocaleString()}
                              </div>
                              <div className="flex gap-1">
                                <Button
                                  variant="ghost"
                                  size="sm"
                                  className="h-6 w-6 p-0 text-blue-600 hover:text-blue-700"
                                  onClick={() => handleEditMember(member)}
                                >
                                  <Edit className="h-3 w-3" />
                                </Button>
                                <AlertDialog>
                                  <AlertDialogTrigger asChild>
                                    <Button
                                      variant="ghost"
                                      size="sm"
                                      className="h-6 w-6 p-0 text-red-600 hover:text-red-700"
                                    >
                                      <Trash2 className="h-3 w-3" />
                                    </Button>
                                  </AlertDialogTrigger>
                                <AlertDialogContent>
                                  <AlertDialogHeader>
                                    <AlertDialogTitle>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</AlertDialogTitle>
                                    <AlertDialogDescription>
                                      ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å "{member.name}" ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏° "{team.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                                      ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
                                    </AlertDialogDescription>
                                  </AlertDialogHeader>
                                  <AlertDialogFooter>
                                    <AlertDialogCancel>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</AlertDialogCancel>
                                    <AlertDialogAction 
                                      onClick={() => handleDeleteMember(member.id)}
                                      className="bg-red-600 hover:bg-red-700"
                                    >
                                      ‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                                    </AlertDialogAction>
                                  </AlertDialogFooter>
                                </AlertDialogContent>
                              </AlertDialog>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-4">
                        <p className="text-sm text-gray-500 italic mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ</p>
                        <p className="text-xs text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ</p>
                      </div>
                    )}
                  </div>
                </div>
              )
            })}
          </div>
        </CardContent>
      </Card>

      {/* All Members List */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Users className="h-5 w-5" />
            ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({members.length} ‡∏Ñ‡∏ô)
          </CardTitle>
        </CardHeader>
        <CardContent>
          {members.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              {members.map((member) => (
                <div key={member.id} className="flex items-center justify-between bg-white p-3 rounded border">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                      <span className="text-xs font-medium">
                        {member.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                      </span>
                    </div>
                    <div>
                      <p className="text-sm font-medium">{member.name}</p>
                      <div className="flex items-center gap-2 text-xs text-gray-500">
                        <Phone className="h-3 w-3" />
                        {member.phone}
                      </div>
                      {member.bankName && (
                        <div className="text-xs text-gray-500">
                          üè¶ {member.bankName} {member.bankAccount && `(${member.bankAccount})`}
                        </div>
                      )}
                      <Badge variant="outline" className="text-xs mt-1">
                        {member.team?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡∏°'}
                      </Badge>
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <div className="flex items-center gap-1 text-xs text-gray-600">
                      <DollarSign className="h-3 w-3" />
                      {member.salary.toLocaleString()}
                    </div>
                    <div className="flex gap-1">
                      <Button
                        variant="ghost"
                        size="sm"
                        className="h-6 w-6 p-0 text-blue-600 hover:text-blue-700"
                        onClick={() => handleEditMember(member)}
                      >
                        <Edit className="h-3 w-3" />
                      </Button>
                      <AlertDialog>
                        <AlertDialogTrigger asChild>
                          <Button
                            variant="ghost"
                            size="sm"
                            className="h-6 w-6 p-0 text-red-600 hover:text-red-700"
                          >
                            <Trash2 className="h-3 w-3" />
                          </Button>
                        </AlertDialogTrigger>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</AlertDialogTitle>
                          <AlertDialogDescription>
                            ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å "{member.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                            ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</AlertDialogCancel>
                          <AlertDialogAction 
                            onClick={() => handleDeleteMember(member.id)}
                            className="bg-red-600 hover:bg-red-700"
                          >
                            ‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8">
              <Users className="h-12 w-12 text-gray-400 mx-auto mb-4" />
              <p className="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
              <p className="text-sm text-gray-400 mt-2">‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}